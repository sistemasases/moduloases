'use strict';define(['jquery','block_ases/bootstrap','block_ases/datatables.net','block_ases/datatables.net-buttons','block_ases/buttons.flash','block_ases/jszip','block_ases/pdfmake','block_ases/buttons.html5','block_ases/buttons.print','block_ases/sweetalert','block_ases/select2'],function(a){var m;return{init:function init(){function o(){a.ajax({type:'POST',url:'../managers/user_management/load_role.php',async:!1,success:function success(E){for(role in a('#role_select').empty(),E){var F='<option value="'+E[role].nombre_rol+'">'+E[role].nombre_rol+'</option>';a('#role_select').append(F)}roleLoaded=!0},dataType:'json',error:function error(){alert('error al cargar roles')}})}function p(E,F){var G=E;G||(G=a('#users').val()),a.ajax({type:'POST',data:{dat:G,idinstancia:D()},url:'../managers/user_management/search_user.php',success:function success(H){F?F(H):H.error?(swal('Error',H.error,'error'),a('.assignment_li').addClass('hidden'),a('#form_mon_student').css({display:'none'}),a('#users').val('').trigger('change.select2'),a('#users').prop('disabled',!1),a('#name_lastname').val(' '),a('#search_button').prop('disabled',!1)):(a('#contenedor_add_fields').html(''),''==H.firstname?(swal('Error','El usuario no existe en la base de datos','error'),a('#users').prop('disabled',!1)):(a('.assignment_li').removeClass('hidden'),a('#name_lastname').val(H.firstname+' '+H.lastname),a('#user_id').val(H.id),''==H.rol?a('#role_select').val('no_asignado'):('profesional_ps'==H.rol?(a('#select_prof_type').val(H.profesion),a('#form_prof_type').fadeIn(),a('#boss_li').fadeOut(),a('#form_mon_student').fadeOut()):'monitor_ps'==H.rol?(t(),u(4,H.boss),a('#form_mon_student').fadeIn(),a('#form_prof_type').fadeOut()):'practicante_ps'==H.rol?(u(7,H.boss),a('#form_mon_student').fadeOut(),a('#form_prof_type').fadeOut()):(a('#boss_li').fadeOut(),a('#form_mon_student').fadeOut(),a('#form_prof_type').fadeOut()),a('#role_select').val(H.rol))))},dataType:'json',error:function error(){swal('Error','El usuario no existe en la base de datos','error'),a('.assignment_li').addClass('hidden'),a('#form_mon_student').css({display:'none'}),a('#users').val('').trigger('change.select2'),a('#users').prop('disabled',!1),a('#name_lastname').val(' '),a('#search_button').prop('disabled',!1)}})}function q(){var E=a('#role_select').val(),F=a('#users').val(),G=[];if(a('input[name="array_students[]"]').each(function(){G.push(a(this).val().split(' - ')[0])}),a('select[name="array_students[]"]').each(function(){G.push(a(this).val().split(' - ')[0])}),'profesional_ps'==E){var H=a('#select_prof_type').val();if('no_asignado'==H)swal('Error','El usuario no tiene un "tipo de profesional" asignado, debe asignar un "tipo de profesional".','error');else{var I={role:E,username:F,professional:H,idinstancia:D()};a.ajax({type:'POST',data:I,url:'../managers/user_management/update_role_user.php',success:function success(K){swal('Informaci\xF3n!',K,'info'),p(F)},dataType:'text',cache:'false',error:function error(){swal('Error','Ha ocurrido un error asignando profesional','error')}})}}else if('monitor_ps'==E){var J=a('#boss_select').val();a.ajax({type:'POST',data:{role:E,username:F,students:G,boss:J,idinstancia:D()},url:'../managers/user_management/update_role_user.php',success:function success(K){swal({title:'Informaci\xF3n!',text:K,type:'info',html:!0,confirmButtonColor:'#d51b23',confirmButtonText:'Ok!',closeOnConfirm:!0}),p(F)},dataType:'text',cache:'false',error:function error(){swal('Error','Ha ocurrido un error','error')}})}else if('practicante_ps'==E){var J=a('#boss_select').val();a.ajax({type:'POST',data:{role:E,username:F,boss:J,idinstancia:D()},url:'../managers/user_management/update_role_user.php',success:function success(K){swal({title:'Informaci\xF3n!',text:K,type:'info',html:!0,confirmButtonColor:'#d51b23',confirmButtonText:'Ok!',closeOnConfirm:!0}),p(F)},dataType:'text',cache:'false',error:function error(){swal('Error','Ha ocurrido un error','error')}})}else a.ajax({type:'POST',data:{role:E,username:F,idinstancia:D()},url:'../managers/user_management/update_role_user.php',success:function success(K){swal('Informaci\xF3n!',K,'info')},dataType:'text',cache:'false',error:function error(){swal('Error','Ha ocurrido un error','error')}})}function r(E){a('#'+E).select2({language:{noResults:function noResults(){return'No hay resultado'},searching:function searching(){return'Buscando..'}},dropdownAutoWidth:!0})}function s(E){var G=a('#contenedor_add_fields'),H=a('.inputs_students').length+1,I=H;if(H<=10){I++;var J='<option value="-1">-----------------------</option>';for(var K in E)J+='<option value="'+E[K].username+'">'+E[K].username+' - '+E[K].firstname+' '+E[K].lastname+'</option>';a('#contenedor_add_fields').append('<div class="select-pilos"><select class="inputs_students" name="array_students[]" id="campo_'+I+'"">'+J+'</select></div>'),r('campo_'+I),H++}}function t(){var E=[],F=a('#user_id').val();E.push({name:'function',value:'load_grupal'}),E.push({name:'user_management',value:F}),E.push({name:'idinstancia',value:D()}),a.ajax({type:'POST',data:E,url:'../managers/user_management/seguimiento.php',success:function success(G){if(a('#contenedor_add_fields').html(''),0!=G.rows){for(var I in m)'<option value="'+m[I].username+'">'+m[I].username+' - '+m[I].firstname+' '+m[I].lastname+'</option>';var J=G.content;for(x in J)a('#contenedor_add_fields').append('<div id="contenedor_add_fields"> <div class="added_add_fields"> <input type="text"  class="inputs_students" name="array_students[]" id="campo_1" value="'+J[x].username+' - '+J[x].firstname+' '+J[x].lastname+'" readonly/> <a href="#" class="eliminar_add_fields"><img src="../icon/ico_wrong.png"></a> </div> </div>')}else;},dataType:'json',cache:'false',error:function error(){alert('error al cargar estudiantes')}})}function u(E,F){var G=[],H=0;G.push({name:'function',value:'cargar'}),G.push({name:'role',value:E}),G.push({name:'idinstancia',value:D()}),a.ajax({type:'POST',data:G,url:'../managers/user_management/search_user.php',success:function success(I){for(x in a('#boss_select').html(''),a('#boss_select').append('<option value="ninguno">Ninguno</option>'),I){var J=I[x].firstname.split(' '),K=I[x].lastname.split(' '),L=!1;F==I[x].id?(a('#boss_select').append('<option value="'+I[x].id+'" selected>'+I[x].username+'-'+J[0]+' '+K[0]+'</option>'),L=!0,H=I[x].id):a('#boss_select').append('<option value="'+I[x].id+'" >'+I[x].username+'-'+J[0]+' '+K[0]+'</option>')}a('#boss_li').removeClass('hide')},dataType:'json',cache:'false',error:function error(){alert('error al cargar profesionales')}})}function v(E){var F=[],G=a('#user_id').val(),H=a('#users').val();F.push({name:'deleteStudent',value:'delete'}),F.push({name:'student',value:E.split(' - ')[0]}),F.push({name:'username',value:H}),F.push({name:'idinstancia',value:D()}),a.ajax({type:'POST',data:F,url:'../managers/user_management/update_role_user.php',success:function success(){},dataType:'json',cache:'false',error:function error(){alert('Error al eliminar estudiante')}})}function w(){a.ajax({type:'POST',data:{idinstancia:D()},url:'../managers/user_management/load_role_users.php',success:function success(E){a('#div_users').empty(),a('#div_users').append('<table id="tableUsers" class="display" cellspacing="0" width="100%"><thead><thead></table>');a('#tableUsers').DataTable(E);a('#div_users #delete_user').css('cursor','pointer')},dataType:'json',cache:'false',error:function error(){alert('Error al cargar usuarios')}})}function y(E,F){var G=[];G.push({name:'function',value:'load_grupal'}),G.push({name:'user_management',value:E.id}),G.push({name:'idinstancia',value:D()}),a.ajax({type:'POST',data:G,url:'../managers/user_management/seguimiento.php',success:function success(H){if(0!=H.rows){var I=H.content,J='<p align=justify">Se ha encontrado que el usuario tiene asignado el rol MONITOR y tiene a cargo los siguientes estudiantes:</p><br><br> ';for(x in J+='<div class="pre-scrollable" style="max-height:200px"><table id="tableStudent" class="table table-striped"> <thead> <tr> <th>C\xF3digo</th> <th>Nombre</th> <th>Apellido</th></tr> </thead><tbody>',I)J+='<tr> <td>'+I[x].username+'</td> <td>'+I[x].firstname+'</td> <td>'+I[x].lastname+'</td> </tr>';J+='</tbody></table></div><br><br><p align=justify">Para continuar se crear\xE1 un nuevo usuario con rol monitor quien se har\xE1 a cargo de los anteriores estudiante(s).<br> Por favor escribe el c\xF3digo del nuevo usuario:</p>';var K='';K=F?'Antes de eliminar!':'Antes de Actualizar!',swal({title:K,html:!0,text:J,type:'input',showCancelButton:!0,closeOnConfirm:!1,confirmButtonColor:'#d51b23',confirmButtonText:'Continuar',cancelButtonText:'Cancelar!',animation:'slide-from-top',inputPlaceholder:'C\xF3digo'},function(L){return!1!==L&&(''===L?(swal.showInputError('Escibe el c\xF3digo del nuevo monitor!'),!1):void p(L,function(M){return M.error?swal.showInputError(M.error):z(M,E,F),!1}))})}else q(),w()},dataType:'json',cache:'false',error:function error(){alert('error al validar monitor')}})}function z(E,F,G){var H='';H='ninguno'==E.rol?'El usuario <strong>'+E.firstname+' '+E.lastname+'</strong> con c\xF3digo <strong>'+E.username+'</strong> se le asiganara el rol monitor y tendr\xE1 a cargo los estudiantes del anterior monitor<br>\xBFEst\xE1 de acuerdo con los cambios que se efectuar\xE1n?':'El usuario <strong>'+E.firstname+' '+E.lastname+'</strong> con c\xF3digo <strong>'+E.username+'</strong> ya tiene el rol <strong>'+E.rol+'</strong>  en el sistema.<br>Perder\xE1 el presente rol y se le asiganar\xE1 el rol monitor.<br> Tendr\xE1 a cargo los estudiantes del anterior monitor.<br><br><strong>\xBFEst\xE1s de acuerdo con los cambios que se efectuar\xE1n?</strong>',swal({title:'Est\xE1s seguro/a?',text:H,type:'warning',html:!0,showCancelButton:!0,confirmButtonColor:'#d51b23',confirmButtonText:'Si!',cancelButtonText:'Atras!',closeOnConfirm:!1,closeOnCancel:!1,animation:'slide-from-top'},function(I){I?A(E,F,G):y(F,G)})}function A(E,F,G){var H=[];H.push({name:'changeMonitor',value:'changeMonitor'}),H.push({name:'oldUser',value:JSON.stringify([F.id,F.username])}),H.push({name:'newUser',value:JSON.stringify([E.id,E.username])}),H.push({name:'isdelete',value:G}),H.push({name:'idinstancia',value:D()}),a.ajax({type:'POST',data:H,url:'../managers/user_management/update_role_user.php',success:function success(I){1==I?(G?swal('Eliminado!','El proceso se eliminaci\xF3n de complet\xF3 satisfactoriamente.','success'):(swal('Hecho!','El proceso de reasignaci\xF3n de estudiantes se complet\xF3 satisfactoriamente. Por favor actualiza y guarda el nuevo rol','success'),q(),w()),w()):swal('Error!',I,'error')},dataType:'text',cache:'false',error:function error(){alert('Error al cambiar monitor')}})}function B(E){var F=[];F.push({name:'deleteProfesional',value:'deleteProfesional'}),F.push({name:'user',value:JSON.stringify([E.id,E.username])}),F.push({name:'idinstancia',value:D()}),a.ajax({type:'POST',data:F,url:'../managers/user_management/update_role_user.php',success:function success(G){1==G?(swal('Eliminado!','El proceso se eliminaci\xF3n de complet\xF3 satisfactoriamente.','success'),w()):swal('Error!',G,'error')},dataType:'json',cache:'false',error:function error(){alert('Error al eliminar profesional')}})}function C(E){var F=[];F.push({name:'deleteOtheruser',value:'deleteOtheruser'}),F.push({name:'user',value:JSON.stringify([E.id,E.username,E.rol])}),F.push({name:'idinstancia',value:D()}),a.ajax({type:'POST',data:F,url:'../managers/user_management/update_role_user.php',success:function success(G){1==G?(swal('Eliminado!','El proceso se eliminaci\xF3n de complet\xF3 satisfactoriamente.','success'),w()):swal('Error!',G,'error')},dataType:'json',cache:'false',error:function error(){alert('Error al eliminar otros usuarios')}})}function D(){var E=location.search.split('&');for(x in E)if(0<=E[x].indexOf('instanceid')){var F=E[x].split('=');return F[1]}return 0}a('#collapse_div').removeClass('hidden'),a('#users').select2({language:{noResults:function noResults(){return'No hay resultado'},searching:function searching(){return'Buscando..'}},dropdownAutoWidth:!0}),a(document).ready(function(){a('.assignment_li').css({display:'none'}),a('#form_mon_student').css({display:'none'}),a('#search_button').on('click',function(){a('#search_button').prop('disabled',!0),o(),p(),a('#users').prop('disabled',!0),a('.assignment_li').show()}),a('#ok-button').on('click',function(){var F=a('#role_select').val();p(null,function(G){if('monitor_ps'==G.rol&&G.rol!=F){var H=[];H.id=a('#user_id').val(),H.username=a('#users').val(),y(H,!1)}else q(),w()})}),a('#cancel-button').on('click',function(){a('.assignment_li').addClass('hidden'),a('#boss_li').fadeOut(),a('#form_mon_student').fadeOut(),a('#users').val('').trigger('change.select2'),a('#users').prop('disabled',!1),a('#search_button').prop('disabled',!1),a('#name_lastname').val(' '),a('#form_prof_type').fadeOut()}),a('#form_mon_estudiante').css({display:'none'}),a('#form_prof_type').css({display:'none'}),a('#role_select').on('change',function(){'monitor_ps'==a('#role_select').val()?(a('#form_prof_type').fadeOut(),a('#form_mon_student').fadeIn(),u(4),a('#boss_li').fadeIn()):'profesional_ps'==a('#role_select').val()?(a('#form_prof_type').fadeIn(),a('#boss_li').fadeOut(),a('#form_mon_student').fadeOut()):'practicante_ps'==a('#role_select').val()?(a('#form_prof_type').fadeOut(),a('#form_mon_student').fadeOut(),u(7),a('#boss_li').fadeIn()):(a('#boss_li').fadeOut(),a('#form_mon_student').fadeOut(),a('#form_prof_type').fadeOut())}),a('#list-users-panel').on('click',function(){w()}),a('#div_users').on('click','#delete_user',function(){var F=a('#div_users #tableUsers').DataTable(),G=a(this).parent(),H=a(this).children('span').attr('id'),I=F.cell(G).index().column,J=F.cell(F.row(G).index(),0).data(),K=F.cell(F.row(G).index(),1).data(),L=F.cell(F.row(G).index(),2).data(),M=F.cell(F.row(G).index(),3).data(),N=[];N.id=H,N.username=J,swal({title:'Estas seguro/a?',text:'Al usuario <strong>'+K+' '+L+'</strong> con c\xF3digo <strong>'+J+'</strong> se le inhabilitar\xE1 los permisos del rol <strong>'+M+'</strong>.<br><strong>\xBFEst\xE1s de acuerdo con los cambios que se efectuar\xE1n?</strong>',type:'warning',html:!0,showCancelButton:!0,confirmButtonColor:'#d51b23',confirmButtonText:'Si!',cancelButtonText:'No',closeOnConfirm:!0},function(O){O&&p(J,function(P){N.rol=P.rol;var Q=P.rol;'monitor_ps'===Q?y(N,!0):'profesional_ps'===Q?B(N):C(N)})})})}),a('body').on('click','.eliminar_add_fields',function(){var F=a('#contenedor_add_fields div').length+1,G=a(this).parent('div').children('input').val(),H=a(this).parent('div');G&&swal({title:'Estas seguro/a?',text:'Se desvincular\xE1 el prensente monitor del estudiante con codigo '+G,type:'warning',showCancelButton:!0,confirmButtonColor:'#d51b23',confirmButtonText:'Si!',cancelButtonText:'No',closeOnConfirm:!0},function(I){I&&(v(G),H.remove(),F--)})}),a('#agregarCampo').click(function(){a.ajax({type:'POST',data:{function:'students_consult',instancia:D()},url:'../managers/user_management/seguimiento.php',success:function success(E){m=E,s(m)},dataType:'json',cache:'false',error:function error(){alert('error al consultar estudiantes')}})})}}});