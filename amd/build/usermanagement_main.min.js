/*
 * @package    block_ases/usermanagement
 * @copyright  ASES
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","block_ases/bootstrap","block_ases/jquery.dataTables","block_ases/sweetalert","block_ases/select2"],(function(e,a,r,n,t){var s;return{init:function(){e("#collapse_div").removeClass("hidden"),e("#users").select2({language:{noResults:function(){return"No hay resultado"},searching:function(){return"Buscando.."}},dropdownAutoWidth:!0});var a,r=!1;function n(r,n){var t=r;t||(t=e("#users").val()),e.ajax({type:"POST",data:{dat:t,idinstancia:u()},url:"../managers/user_management/search_user.php",success:function(r){var t,i;a=JSON.parse(JSON.stringify(r)),n?n(r):r.error?(swal("Error",r.error,"error"),e(".assignment_li").addClass("hidden"),e("#form_mon_student").css({display:"none"}),e("#users").val("").trigger("change.select2"),e("#users").prop("disabled",!1),e("#name_lastname").val(" "),e("#search_button").prop("disabled",!1)):(e("#contenedor_add_fields").html(""),""==r.firstname?(swal("Error","El usuario no existe en la base de datos","error"),e("#users").prop("disabled",!1)):(e(".assignment_li").removeClass("hidden"),e("#name_lastname").val(r.firstname+" "+r.lastname),e("#user_id").val(r.id),""==r.rol?e("#role_select").val("no_asignado"):("profesional_ps"==r.rol?(e("#select_prof_type").val(r.profesion),e("#form_prof_type").fadeIn(),e("#boss_li").fadeOut(),e("#form_mon_student").fadeOut(),e("#academic_program_li").fadeOut(),e("#facult_program_li").fadeOut()):"monitor_ps"==r.rol?(t=new Array,i=e("#user_id").val(),t.push({name:"function",value:"load_grupal"}),t.push({name:"user_management",value:i}),t.push({name:"idinstancia",value:u()}),e.ajax({type:"POST",data:t,url:"../managers/user_management/usermanagement_report.php",success:function(a){if(e("#contenedor_add_fields").html(""),0!=a.rows){for(var r in s)s[r].username,s[r].username,s[r].firstname,s[r].lastname;var n=a.content;for(x in n)e("#contenedor_add_fields").append('<div id="contenedor_add_fields"> <div class="added_add_fields"> <input type="text"  class="inputs_students" name="array_students[]" id="campo_1" value="'+n[x].username+" - "+n[x].firstname+" "+n[x].lastname+'" readonly/> <a href="#" class="eliminar_add_fields"><img src="../icon/ico_wrong.png"></a> </div> </div>')}},dataType:"json",cache:"false",error:function(e){alert("error al cargar estudiantes")}}),o(4,r.boss),e("#form_mon_student").fadeIn(),e("#form_prof_type").fadeOut(),e("#academic_program_li").fadeOut(),e("#facult_program_li").fadeOut()):"practicante_ps"==r.rol?(o(7,r.boss),e("#form_mon_student").fadeOut(),e("#form_prof_type").fadeOut(),e("#academic_program_li").fadeOut(),e("#facult_program_li").fadeOut()):"director_prog"==r.rol?(e("#form_mon_student").fadeOut(),e("#form_prof_type").fadeOut(),e("#boss_li").fadeOut(),e("#academic_program_li").fadeIn(),e("#facult_program_li").fadeOut()):"vcd_academico"==r.rol?(e("#form_mon_student").fadeOut(),e("#form_prof_type").fadeOut(),e("#boss_li").fadeOut(),e("#academic_program_li").fadeOut(),e("#facult_program_li").fadeIn()):(e("#boss_li").fadeOut(),e("#form_mon_student").fadeOut(),e("#form_prof_type").fadeOut()),e("#role_select").val(r.rol))))},dataType:"json",error:function(a){swal("Error","El usuario no existe en la base de datos","error"),e(".assignment_li").addClass("hidden"),e("#form_mon_student").css({display:"none"}),e("#users").val("").trigger("change.select2"),e("#users").prop("disabled",!1),e("#name_lastname").val(" "),e("#search_button").prop("disabled",!1)}})}function t(){var r=e("#role_select").val(),t=e("#users").val(),s=new Array;if(e('input[name="array_students[]"]').each((function(){s.push(e(this).val().split(" - ")[0])})),e('select[name="array_students[]"]').each((function(){s.push(e(this).val().split(" - ")[0])})),"profesional_ps"==r){var o=e("#select_prof_type").val();if("no_asignado"==o)swal("Error",'El usuario no tiene un "tipo de profesional" asignado, debe asignar un "tipo de profesional".',"error");else{var i={role:r,username:t,professional:o,idinstancia:u()};e.ajax({type:"POST",data:i,url:"../managers/user_management/update_role_user.php",success:function(e){swal("Información!",e,"info"),n(t)},dataType:"text",cache:"false",error:function(e){swal("Error","Ha ocurrido un error asignando profesional","error")}})}}else if("monitor_ps"==r){var l=e("#boss_select").val();e.ajax({type:"POST",data:{role:r,username:t,students:s,boss:l,idinstancia:u()},url:"../managers/user_management/update_role_user.php",success:function(e){swal({title:"Información!",text:e,type:"info",html:!0,confirmButtonColor:"#d51b23",confirmButtonText:"Ok!",closeOnConfirm:!0}),n(t)},dataType:"text",cache:"false",error:function(e){swal("Error","Ha ocurrido un error","error")}})}else if("practicante_ps"==r){l=e("#boss_select").val();e.ajax({type:"POST",data:{role:r,username:t,boss:l,idinstancia:u()},url:"../managers/user_management/update_role_user.php",success:function(e){swal({title:"Información!",text:e,type:"info",html:!0,confirmButtonColor:"#d51b23",confirmButtonText:"Ok!",closeOnConfirm:!0}),n(t)},dataType:"text",cache:"false",error:function(e){swal("Error","Ha ocurrido un error","error")}})}else if("director_prog"==r){var c=e("#academic_program_select").val();e.ajax({type:"POST",data:{role:r,username:t,academic_program:c,idinstancia:u()},url:"../managers/user_management/update_role_user.php",success:function(e){swal({title:"Información!",text:e,type:"info",html:!0,confirmButtonColor:"#d51b23",confirmButtonText:"Ok!",closeOnConfirm:!0}),n(t)},dataType:"text",cache:"false",error:function(e){swal("Error","Ha ocurrido un error","error")}})}else if("vcd_academico"==r){var d=e("#facult_program_select").val();e.ajax({type:"POST",data:{role:r,username:t,facult_program:d,idinstancia:u()},url:"../managers/user_management/update_role_user.php",success:function(e){swal({title:"Información!",text:e,type:"info",html:!0,confirmButtonColor:"#d51b23",confirmButtonText:"Ok!",closeOnConfirm:!0}),n(t)},dataType:"text",cache:"false",error:function(e){swal("Error","Ha ocurrido un error","error")}})}else e.ajax({type:"POST",data:{uid:a.id,role:r,username:t,idinstancia:u(),security:e("#checkbox-security").is(":checked")},url:"../managers/user_management/update_role_user.php",success:function(e){swal("Información!",e,"info")},dataType:"text",cache:"false",error:function(e){console.log(e),swal("Error","Ha ocurrido un error","error")}})}function o(a,r){var n=new Array;n.push({name:"function",value:"cargar"}),n.push({name:"role",value:a}),n.push({name:"idinstancia",value:u()}),e.ajax({type:"POST",data:n,url:"../managers/user_management/search_user.php",success:function(a){for(x in e("#boss_select").html(""),e("#boss_select").append('<option value="ninguno">Ninguno</option>'),a){var n=a[x].firstname.split(" "),t=a[x].lastname.split(" ");r==a[x].id?(e("#boss_select").append('<option value="'+a[x].id+'" selected>'+a[x].username+"-"+n[0]+" "+t[0]+"</option>"),!0,a[x].id):e("#boss_select").append('<option value="'+a[x].id+'" >'+a[x].username+"-"+n[0]+" "+t[0]+"</option>")}e("#boss_li").removeClass("hide")},dataType:"json",cache:"false",error:function(e){alert("error al cargar profesionales")}})}function i(){e.ajax({type:"POST",data:{idinstancia:u()},url:"../managers/user_management/load_role_users.php",success:function(a){e("#div_users").empty(),e("#div_users").append('<table id="tableUsers" class="display" cellspacing="0" width="100%"><thead><thead></table>');e("#tableUsers").DataTable(a);e("#div_users #delete_user").css("cursor","pointer")},dataType:"json",cache:"false",error:function(e){alert("Error al cargar usuarios")}})}function l(a,r){var s=new Array;s.push({name:"function",value:"load_grupal"}),s.push({name:"user_management",value:a.id}),s.push({name:"idinstancia",value:u()}),e.ajax({type:"POST",data:s,url:"../managers/user_management/usermanagement_report.php",success:function(s){if(0!=s.rows){var o=s.content,c='<p align=justify">Se ha encontrado que el usuario tiene asignado el rol MONITOR y tiene a cargo los siguientes estudiantes:</p><br><br> ';for(x in c+='<div class="pre-scrollable" style="max-height:200px"><table id="tableStudent" class="table table-striped"> <thead> <tr> <th>Código</th> <th>Nombre</th> <th>Apellido</th></tr> </thead><tbody>',o)c+="<tr> <td>"+o[x].username+"</td> <td>"+o[x].firstname+"</td> <td>"+o[x].lastname+"</td> </tr>";c+='</tbody></table></div><br><br><p align=justify">Para continuar se creará un nuevo usuario con rol monitor quien se hará a cargo de los anteriores estudiante(s).<br> Por favor escribe el código del nuevo usuario:</p>';var d="";d=r?"Antes de eliminar!":"Antes de Actualizar!",swal({title:d,html:!0,text:c,type:"input",showCancelButton:!0,closeOnConfirm:!1,confirmButtonColor:"#d51b23",confirmButtonText:"Continuar",cancelButtonText:"Cancelar!",animation:"slide-from-top",inputPlaceholder:"Código"},(function(s){return!1!==s&&(""===s?(swal.showInputError("Escibe el código del nuevo monitor!"),!1):void n(s,(function(n){return n.error?swal.showInputError(n.error):function(a,r,n){var s="";s="ninguno"==a.rol?"El usuario <strong>"+a.firstname+" "+a.lastname+"</strong> con código <strong>"+a.username+"</strong> se le asiganara el rol monitor y tendrá a cargo los estudiantes del anterior monitor<br>¿Está de acuerdo con los cambios que se efectuarán?":"El usuario <strong>"+a.firstname+" "+a.lastname+"</strong> con código <strong>"+a.username+"</strong> ya tiene el rol <strong>"+a.rol+"</strong>  en el sistema.<br>Perderá el presente rol y se le asiganará el rol monitor.<br> Tendrá a cargo los estudiantes del anterior monitor.<br><br><strong>¿Estás de acuerdo con los cambios que se efectuarán?</strong>";swal({title:"Estás seguro/a?",text:s,type:"warning",html:!0,showCancelButton:!0,confirmButtonColor:"#d51b23",confirmButtonText:"Si!",cancelButtonText:"Atras!",closeOnConfirm:!1,closeOnCancel:!1,animation:"slide-from-top"},(function(s){s?function(a,r,n){var s=new Array;s.push({name:"changeMonitor",value:"changeMonitor"}),s.push({name:"oldUser",value:JSON.stringify([r.id,r.username])}),s.push({name:"newUser",value:JSON.stringify([a.id,a.username])}),s.push({name:"isdelete",value:n}),s.push({name:"idinstancia",value:u()}),e.ajax({type:"POST",data:s,url:"../managers/user_management/update_role_user.php",success:function(e){1==e?(n?swal("Eliminado!","El proceso se eliminación de completó satisfactoriamente.","success"):(swal("Hecho!","El proceso de reasignación de estudiantes se completó satisfactoriamente. Por favor actualiza y guarda el nuevo rol","success"),t(),i()),i()):swal("Error!",e,"error")},dataType:"text",cache:"false",error:function(e){alert("Error al cambiar monitor")}})}(a,r,n):l(r,n)}))}(n,a,r),!1})))}))}else!function(a,r){var n=new Array;n.push({name:"deleteMonitorWithoutStudents",value:"deleteMonitorWithoutStudents"}),n.push({name:"oldUser",value:JSON.stringify([a.id,a.username])}),n.push({name:"idinstancia",value:u()}),e.ajax({type:"POST",data:n,url:"../managers/user_management/update_role_user.php",success:function(e){1==e?(swal("Hecho!","El usuario ha sido eliminado satisfactoriamente.","success"),t(),i()):swal("Error!",e,"error")},dataType:"text",cache:"false",error:function(e){alert("Error al eliminar monitor sin estudiantes asignados")}})}(a,u()),t(),i()},dataType:"json",cache:"false",error:function(e){alert("error al validar monitor")}})}function u(){var e=location.search.split("&");for(x in e){if(e[x].indexOf("instanceid")>=0)return e[x].split("=")[1]}return 0}e("#academic_program_li").css({display:"none"}),e("#facult_program_li").css({display:"none"}),e(".assignment_li").css({display:"none"}),e("#form_mon_student").css({display:"none"}),e("#search_button").on("click",(function(){e("#search_button").prop("disabled",!0),r||e.ajax({type:"POST",url:"../managers/user_management/load_role.php",async:!1,success:function(a){for(role in e("#role_select").empty(),a){var n='<option value="'+a[role].nombre_rol+'">'+a[role].nombre_rol+"</option>";e("#role_select").append(n)}r=!0},dataType:"json",error:function(e){alert("error al cargar roles")}}),n(),e("#users").prop("disabled",!0),e(".assignment_li").show()})),e("#ok-button").on("click",(function(){var r=e("#role_select").val();if("monitor_ps"==a.rol&&a.rol!=r){var n=new Array;n.id=e("#user_id").val(),n.username=e("#users").val(),l(n,!1)}else t(),i()})),e("#cancel-button").on("click",(function(){e(".assignment_li").addClass("hidden"),e("#boss_li").fadeOut(),e("#form_mon_student").fadeOut(),e("#users").val("").trigger("change.select2"),e("#users").prop("disabled",!1),e("#search_button").prop("disabled",!1),e("#name_lastname").val(" "),e("#form_prof_type").fadeOut()})),e("#form_mon_estudiante").css({display:"none"}),e("#form_prof_type").css({display:"none"}),e("#role_select").on("change",(function(){"monitor_ps"==e("#role_select").val()?(e("#form_prof_type").fadeOut(),e("#form_mon_student").fadeIn(),o(4),e("#boss_li").fadeIn(),e("#academic_program_li").fadeOut(),e("#facult_program_li").fadeOut()):"profesional_ps"==e("#role_select").val()?(e("#form_prof_type").fadeIn(),e("#boss_li").fadeOut(),e("#form_mon_student").fadeOut(),e("#academic_program_li").fadeOut(),e("#facult_program_li").fadeOut()):"practicante_ps"==e("#role_select").val()?(e("#form_prof_type").fadeOut(),e("#form_mon_student").fadeOut(),o(7),e("#boss_li").fadeIn(),e("#facult_program_li").fadeOut(),e("#academic_program_li").fadeOut()):"director_prog"==e("#role_select").val()?(e("#form_prof_type").fadeOut(),e("#form_mon_student").fadeOut(),e("#boss_li").fadeOut(),e("#academic_program_li").fadeIn(),e("#facult_program_li").fadeOut()):"vcd_academico"==e("#role_select").val()?(e("#form_prof_type").fadeOut(),e("#form_mon_student").fadeOut(),e("#boss_li").fadeOut(),e("#academic_program_li").fadeOut(),e("#facult_program_li").fadeIn()):(e("#boss_li").fadeOut(),e("#form_mon_student").fadeOut(),e("#form_prof_type").fadeOut(),e("#academic_program_li").fadeOut())})),e("#list-users-panel").on("click",(function(){i()})),e("#div_users").on("click","span.delete_user",(function(){var a=e("#div_users #tableUsers").DataTable(),r=e(this).parent(),t=r.children("span").attr("id"),s=(a.cell(r).index().column,a.cell(a.row(r).index(),0).data()),o=a.cell(a.row(r).index(),1).data(),c=a.cell(a.row(r).index(),2).data(),d=a.cell(a.row(r).index(),3).data(),m=new Array;m.id=t,m.username=s,swal({title:"Estas seguro/a?",text:"Al usuario <strong>"+o+" "+c+"</strong> con código <strong>"+s+"</strong> se le inhabilitará los permisos del rol <strong>"+d+"</strong>.<br><strong>¿Estás de acuerdo con los cambios que se efectuarán?</strong>",type:"warning",html:!0,showCancelButton:!0,confirmButtonColor:"#d51b23",confirmButtonText:"Si!",cancelButtonText:"No",closeOnConfirm:!0},(function(a){a&&n(s,(function(a){switch(m.rol=a.rol,a.rol){case"monitor_ps":l(m,!0);break;case"profesional_ps":!function(a){var r=new Array;r.push({name:"deleteProfesional",value:"deleteProfesional"}),r.push({name:"user",value:JSON.stringify([a.id,a.username])}),r.push({name:"idinstancia",value:u()}),e.ajax({type:"POST",data:r,url:"../managers/user_management/update_role_user.php",success:function(e){1==e?(swal("Eliminado!","El proceso se eliminación de completó satisfactoriamente.","success"),i()):swal("Error!",e,"error")},dataType:"json",cache:"false",error:function(e){alert("Error al eliminar profesional")}})}(m);break;default:!function(a){var r=new Array;r.push({name:"deleteOtheruser",value:"deleteOtheruser"}),r.push({name:"user",value:JSON.stringify([a.id,a.username,a.rol])}),r.push({name:"idinstancia",value:u()}),e.ajax({type:"POST",data:r,url:"../managers/user_management/update_role_user.php",success:function(e){1==e?(swal("Eliminado!","El proceso se eliminación de completó satisfactoriamente.","success"),i()):swal("Error!",e,"error")},dataType:"json",cache:"false",error:function(e){alert("Error al eliminar otros usuarios")}})}(m)}}))}))})),e("body").on("click",".eliminar_add_fields",(function(a){e("#contenedor_add_fields div").length;var r=e(this).parent("div").children("input").val(),n=e(this).parent("div");r&&swal({title:"Estas seguro/a?",text:"Se desvinculará el prensente monitor del estudiante con codigo "+r,type:"warning",showCancelButton:!0,confirmButtonColor:"#d51b23",confirmButtonText:"Si!",cancelButtonText:"No",closeOnConfirm:!0},(function(a){a&&(!function(a){var r=new Array,n=(e("#user_id").val(),e("#users").val());r.push({name:"deleteStudent",value:"delete"}),r.push({name:"student",value:a.split(" - ")[0]}),r.push({name:"username",value:n}),r.push({name:"idinstancia",value:u()}),e.ajax({type:"POST",data:r,url:"../managers/user_management/update_role_user.php",success:function(e){},dataType:"json",cache:"false",error:function(e){alert("Error al eliminar estudiante")}})}(r),n.remove())}))})),e("#agregarCampo").click((function(){e.ajax({type:"POST",data:{function:"students_consult",instancia:u()},url:"../managers/user_management/usermanagement_report.php",success:function(a){!function(a){e("#contenedor_add_fields");var r=e(".inputs_students").length+1,n=r;n++;var t='<option value="-1">-----------------------</option>';for(var s in a)t+='<option value="'+a[s].username+'">'+a[s].username+" - "+a[s].firstname+" "+a[s].lastname+"</option>";e("#contenedor_add_fields").append('<div class="select-pilos"><select class="inputs_students" name="array_students[]" id="campo_'+n+'"">'+t+"</select></div>"),o="campo_"+n,e("#"+o).select2({language:{noResults:function(){return"No hay resultado"},searching:function(){return"Buscando.."}},dropdownAutoWidth:!0}),r++;var o}(s=a)},dataType:"json",cache:"false",error:function(e){alert("error al consultar estudiantes")}})}))}}}));