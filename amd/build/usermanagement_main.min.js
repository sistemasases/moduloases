define(["jquery","block_ases/bootstrap","block_ases/datatables","block_ases/sweetalert","block_ases/select2"],function(a,b,c,d,e){var f;return{init:function(){function b(){a.ajax({type:"POST",url:"../managers/user_management/load_role.php",async:!1,success:function(b){a("#role_select").empty();for(role in b){var c='<option value="'+b[role].nombre_rol+'">'+b[role].nombre_rol+"</option>";a("#role_select").append(c)}roleLoaded=!0},dataType:"json",error:function(a){alert("error al cargar roles")}})}function c(b,c){var d=b;d||(d=a("#users").val()),a.ajax({type:"POST",data:{dat:d,idinstancia:q()},url:"../managers/user_management/search_user.php",success:function(b){c?c(b):b.error?(swal("Error",b.error,"error"),a(".assignment_li").addClass("hidden"),a("#form_mon_student").css({display:"none"}),a("#users").val("").trigger("change.select2"),a("#users").prop("disabled",!1),a("#name_lastname").val(" "),a("#search_button").prop("disabled",!1)):(a("#contenedor_add_fields").html(""),""==b.firstname?(swal("Error","El usuario no existe en la base de datos","error"),a("#users").prop("disabled",!1)):(a(".assignment_li").removeClass("hidden"),a("#name_lastname").val(b.firstname+" "+b.lastname),a("#user_id").val(b.id),""==b.rol?a("#role_select").val("no_asignado"):("profesional_ps"==b.rol?(a("#select_prof_type").val(b.profesion),a("#form_prof_type").fadeIn(),a("#boss_li").fadeOut(),a("#form_mon_student").fadeOut(),a("#academic_program_li").fadeOut()):"monitor_ps"==b.rol?(h(),i(4,b.boss),a("#form_mon_student").fadeIn(),a("#form_prof_type").fadeOut(),a("#academic_program_li").fadeOut()):"practicante_ps"==b.rol?(i(7,b.boss),a("#form_mon_student").fadeOut(),a("#form_prof_type").fadeOut(),a("#academic_program_li").fadeOut()):"director_prog"==b.rol?(a("#form_mon_student").fadeOut(),a("#form_prof_type").fadeOut(),a("#boss_li").fadeOut(),a("#academic_program_li").fadeIn()):(a("#boss_li").fadeOut(),a("#form_mon_student").fadeOut(),a("#form_prof_type").fadeOut()),a("#role_select").val(b.rol))))},dataType:"json",error:function(b){swal("Error","El usuario no existe en la base de datos","error"),a(".assignment_li").addClass("hidden"),a("#form_mon_student").css({display:"none"}),a("#users").val("").trigger("change.select2"),a("#users").prop("disabled",!1),a("#name_lastname").val(" "),a("#search_button").prop("disabled",!1)}})}function d(){var b=a("#role_select").val(),d=a("#users").val(),e=new Array;if(a('input[name="array_students[]"]').each(function(){e.push(a(this).val().split(" - ")[0])}),a('select[name="array_students[]"]').each(function(){e.push(a(this).val().split(" - ")[0])}),"profesional_ps"==b){var f=a("#select_prof_type").val();if("no_asignado"==f)swal("Error",'El usuario no tiene un "tipo de profesional" asignado, debe asignar un "tipo de profesional".',"error");else{var g={role:b,username:d,professional:f,idinstancia:q()};a.ajax({type:"POST",data:g,url:"../managers/user_management/update_role_user.php",success:function(a){swal("Información!",a,"info"),c(d)},dataType:"text",cache:"false",error:function(a){swal("Error","Ha ocurrido un error asignando profesional","error")}})}}else if("monitor_ps"==b){var h=a("#boss_select").val();a.ajax({type:"POST",data:{role:b,username:d,students:e,boss:h,idinstancia:q()},url:"../managers/user_management/update_role_user.php",success:function(a){swal({title:"Información!",text:a,type:"info",html:!0,confirmButtonColor:"#d51b23",confirmButtonText:"Ok!",closeOnConfirm:!0}),c(d)},dataType:"text",cache:"false",error:function(a){swal("Error","Ha ocurrido un error","error")}})}else if("practicante_ps"==b){var h=a("#boss_select").val();a.ajax({type:"POST",data:{role:b,username:d,boss:h,idinstancia:q()},url:"../managers/user_management/update_role_user.php",success:function(a){swal({title:"Información!",text:a,type:"info",html:!0,confirmButtonColor:"#d51b23",confirmButtonText:"Ok!",closeOnConfirm:!0}),c(d)},dataType:"text",cache:"false",error:function(a){swal("Error","Ha ocurrido un error","error")}})}else if("director_prog"==b){var i=a("#academic_program_select").val();a.ajax({type:"POST",data:{role:b,username:d,academic_program:i,idinstancia:q()},url:"../managers/user_management/update_role_user.php",success:function(a){swal({title:"Información!",text:a,type:"info",html:!0,confirmButtonColor:"#d51b23",confirmButtonText:"Ok!",closeOnConfirm:!0}),c(d)},dataType:"text",cache:"false",error:function(a){swal("Error","Ha ocurrido un error","error")}})}else a.ajax({type:"POST",data:{role:b,username:d,idinstancia:q()},url:"../managers/user_management/update_role_user.php",success:function(a){swal("Información!",a,"info")},dataType:"text",cache:"false",error:function(a){swal("Error","Ha ocurrido un error","error")}})}function e(b){a("#"+b).select2({language:{noResults:function(){return"No hay resultado"},searching:function(){return"Buscando.."}},dropdownAutoWidth:!0})}function g(b){var c=(a("#contenedor_add_fields"),a(".inputs_students").length+1),d=c;if(c<=MaxInputs){d++;var f='<option value="-1">-----------------------</option>';for(var g in b)f+='<option value="'+b[g].username+'">'+b[g].username+" - "+b[g].firstname+" "+b[g].lastname+"</option>";a("#contenedor_add_fields").append('<div class="select-pilos"><select class="inputs_students" name="array_students[]" id="campo_'+d+'"">'+f+"</select></div>"),e("campo_"+d),c++}}function h(){var b=new Array,c=a("#user_id").val();b.push({name:"function",value:"load_grupal"}),b.push({name:"user_management",value:c}),b.push({name:"idinstancia",value:q()}),a.ajax({type:"POST",data:b,url:"../managers/user_management/usermanagement_report.php",success:function(b){if(a("#contenedor_add_fields").html(""),0!=b.rows){var c="";for(var d in f)c+='<option value="'+f[d].username+'">'+f[d].username+" - "+f[d].firstname+" "+f[d].lastname+"</option>";var e=b.content;for(x in e)a("#contenedor_add_fields").append('<div id="contenedor_add_fields"> <div class="added_add_fields"> <input type="text"  class="inputs_students" name="array_students[]" id="campo_1" value="'+e[x].username+" - "+e[x].firstname+" "+e[x].lastname+'" readonly/> <a href="#" class="eliminar_add_fields"><img src="../icon/ico_wrong.png"></a> </div> </div>')}},dataType:"json",cache:"false",error:function(a){alert("error al cargar estudiantes")}})}function i(b,c){var d=new Array,e=0;d.push({name:"function",value:"cargar"}),d.push({name:"role",value:b}),d.push({name:"idinstancia",value:q()}),a.ajax({type:"POST",data:d,url:"../managers/user_management/search_user.php",success:function(b){a("#boss_select").html(""),a("#boss_select").append('<option value="ninguno">Ninguno</option>');for(x in b){var d=b[x].firstname.split(" "),f=b[x].lastname.split(" "),g=!1;c==b[x].id?(a("#boss_select").append('<option value="'+b[x].id+'" selected>'+b[x].username+"-"+d[0]+" "+f[0]+"</option>"),g=!0,e=b[x].id):a("#boss_select").append('<option value="'+b[x].id+'" >'+b[x].username+"-"+d[0]+" "+f[0]+"</option>")}a("#boss_li").removeClass("hide")},dataType:"json",cache:"false",error:function(a){alert("error al cargar profesionales")}})}function j(b){var c=new Array,d=(a("#user_id").val(),a("#users").val());c.push({name:"deleteStudent",value:"delete"}),c.push({name:"student",value:b.split(" - ")[0]}),c.push({name:"username",value:d}),c.push({name:"idinstancia",value:q()}),a.ajax({type:"POST",data:c,url:"../managers/user_management/update_role_user.php",success:function(a){},dataType:"json",cache:"false",error:function(a){alert("Error al eliminar estudiante")}})}function k(){a.ajax({type:"POST",data:{idinstancia:q()},url:"../managers/user_management/load_role_users.php",success:function(b){a("#div_users").empty(),a("#div_users").append('<table id="tableUsers" class="display" cellspacing="0" width="100%"><thead><thead></table>');a("#tableUsers").DataTable(b);a("#div_users #delete_user").css("cursor","pointer")},dataType:"json",cache:"false",error:function(a){alert("Error al cargar usuarios")}})}function l(b,e){var f=new Array;f.push({name:"function",value:"load_grupal"}),f.push({name:"user_management",value:b.id}),f.push({name:"idinstancia",value:q()}),a.ajax({type:"POST",data:f,url:"../managers/user_management/usermanagement_report.php",success:function(a){if(0!=a.rows){var f=a.content,g='<p align=justify">Se ha encontrado que el usuario tiene asignado el rol MONITOR y tiene a cargo los siguientes estudiantes:</p><br><br> ';g+='<div class="pre-scrollable" style="max-height:200px"><table id="tableStudent" class="table table-striped"> <thead> <tr> <th>Código</th> <th>Nombre</th> <th>Apellido</th></tr> </thead><tbody>';for(x in f)g+="<tr> <td>"+f[x].username+"</td> <td>"+f[x].firstname+"</td> <td>"+f[x].lastname+"</td> </tr>";g+='</tbody></table></div><br><br><p align=justify">Para continuar se creará un nuevo usuario con rol monitor quien se hará a cargo de los anteriores estudiante(s).<br> Por favor escribe el código del nuevo usuario:</p>';var h="";h=e?"Antes de eliminar!":"Antes de Actualizar!",swal({title:h,html:!0,text:g,type:"input",showCancelButton:!0,closeOnConfirm:!1,confirmButtonColor:"#d51b23",confirmButtonText:"Continuar",cancelButtonText:"Cancelar!",animation:"slide-from-top",inputPlaceholder:"Código"},function(a){return a!==!1&&(""===a?(swal.showInputError("Escibe el código del nuevo monitor!"),!1):void c(a,function(a){return a.error?swal.showInputError(a.error):m(a,b,e),!1}))})}else d(),k()},dataType:"json",cache:"false",error:function(a){alert("error al validar monitor")}})}function m(a,b,c){var d="";d="ninguno"==a.rol?"El usuario <strong>"+a.firstname+" "+a.lastname+"</strong> con código <strong>"+a.username+"</strong> se le asiganara el rol monitor y tendrá a cargo los estudiantes del anterior monitor<br>¿Está de acuerdo con los cambios que se efectuarán?":"El usuario <strong>"+a.firstname+" "+a.lastname+"</strong> con código <strong>"+a.username+"</strong> ya tiene el rol <strong>"+a.rol+"</strong>  en el sistema.<br>Perderá el presente rol y se le asiganará el rol monitor.<br> Tendrá a cargo los estudiantes del anterior monitor.<br><br><strong>¿Estás de acuerdo con los cambios que se efectuarán?</strong>",swal({title:"Estás seguro/a?",text:d,type:"warning",html:!0,showCancelButton:!0,confirmButtonColor:"#d51b23",confirmButtonText:"Si!",cancelButtonText:"Atras!",closeOnConfirm:!1,closeOnCancel:!1,animation:"slide-from-top"},function(d){d?n(a,b,c):l(b,c)})}function n(b,c,e){var f=new Array;f.push({name:"changeMonitor",value:"changeMonitor"}),f.push({name:"oldUser",value:JSON.stringify([c.id,c.username])}),f.push({name:"newUser",value:JSON.stringify([b.id,b.username])}),f.push({name:"isdelete",value:e}),f.push({name:"idinstancia",value:q()}),a.ajax({type:"POST",data:f,url:"../managers/user_management/update_role_user.php",success:function(a){1==a?(e?swal("Eliminado!","El proceso se eliminación de completó satisfactoriamente.","success"):(swal("Hecho!","El proceso de reasignación de estudiantes se completó satisfactoriamente. Por favor actualiza y guarda el nuevo rol","success"),d(),k()),k()):swal("Error!",a,"error")},dataType:"text",cache:"false",error:function(a){alert("Error al cambiar monitor")}})}function o(b){var c=new Array;c.push({name:"deleteProfesional",value:"deleteProfesional"}),c.push({name:"user",value:JSON.stringify([b.id,b.username])}),c.push({name:"idinstancia",value:q()}),a.ajax({type:"POST",data:c,url:"../managers/user_management/update_role_user.php",success:function(a){1==a?(swal("Eliminado!","El proceso se eliminación de completó satisfactoriamente.","success"),k()):swal("Error!",a,"error")},dataType:"json",cache:"false",error:function(a){alert("Error al eliminar profesional")}})}function p(b){var c=new Array;c.push({name:"deleteOtheruser",value:"deleteOtheruser"}),c.push({name:"user",value:JSON.stringify([b.id,b.username,b.rol])}),c.push({name:"idinstancia",value:q()}),a.ajax({type:"POST",data:c,url:"../managers/user_management/update_role_user.php",success:function(a){1==a?(swal("Eliminado!","El proceso se eliminación de completó satisfactoriamente.","success"),k()):swal("Error!",a,"error")},dataType:"json",cache:"false",error:function(a){alert("Error al eliminar otros usuarios")}})}function q(){var a=location.search.split("&");for(x in a)if(a[x].indexOf("instanceid")>=0){var b=a[x].split("=");return b[1]}return 0}a("#collapse_div").removeClass("hidden"),a("#users").select2({language:{noResults:function(){return"No hay resultado"},searching:function(){return"Buscando.."}},dropdownAutoWidth:!0}),a(document).ready(function(){var e=!1;a("#academic_program_li").css({display:"none"}),a(".assignment_li").css({display:"none"}),a("#form_mon_student").css({display:"none"}),a("#search_button").on("click",function(){a("#search_button").prop("disabled",!0),e||b(),c(),a("#users").prop("disabled",!0),a(".assignment_li").show()}),a("#ok-button").on("click",function(){var b=a("#role_select").val();c(null,function(c){if("monitor_ps"==c.rol&&c.rol!=b){var e=new Array;e.id=a("#user_id").val(),e.username=a("#users").val(),l(e,!1)}else d(),k()})}),a("#cancel-button").on("click",function(){a(".assignment_li").addClass("hidden"),a("#boss_li").fadeOut(),a("#form_mon_student").fadeOut(),a("#users").val("").trigger("change.select2"),a("#users").prop("disabled",!1),a("#search_button").prop("disabled",!1),a("#name_lastname").val(" "),a("#form_prof_type").fadeOut()}),a("#form_mon_estudiante").css({display:"none"}),a("#form_prof_type").css({display:"none"}),a("#role_select").on("change",function(){"monitor_ps"==a("#role_select").val()?(a("#form_prof_type").fadeOut(),a("#form_mon_student").fadeIn(),i(4),a("#boss_li").fadeIn(),a("#academic_program_li").fadeOut()):"profesional_ps"==a("#role_select").val()?(a("#form_prof_type").fadeIn(),a("#boss_li").fadeOut(),a("#form_mon_student").fadeOut(),a("#academic_program_li").fadeOut()):"practicante_ps"==a("#role_select").val()?(a("#form_prof_type").fadeOut(),a("#form_mon_student").fadeOut(),i(7),a("#boss_li").fadeIn(),a("#academic_program_li").fadeOut()):"director_prog"==a("#role_select").val()?(a("#form_prof_type").fadeOut(),a("#form_mon_student").fadeOut(),a("#boss_li").fadeOut(),a("#academic_program_li").fadeIn()):(a("#boss_li").fadeOut(),a("#form_mon_student").fadeOut(),a("#form_prof_type").fadeOut(),a("#academic_program_li").fadeOut())}),a("#list-users-panel").on("click",function(){k()}),a("#div_users").on("click","#delete_user",function(){var b=a("#div_users #tableUsers").DataTable(),d=a(this).parent(),e=a(this).children("span").attr("id"),f=(b.cell(d).index().column,b.cell(b.row(d).index(),0).data()),g=b.cell(b.row(d).index(),1).data(),h=b.cell(b.row(d).index(),2).data(),i=b.cell(b.row(d).index(),3).data(),j=new Array;j.id=e,j.username=f,swal({title:"Estas seguro/a?",text:"Al usuario <strong>"+g+" "+h+"</strong> con código <strong>"+f+"</strong> se le inhabilitará los permisos del rol <strong>"+i+"</strong>.<br><strong>¿Estás de acuerdo con los cambios que se efectuarán?</strong>",type:"warning",html:!0,showCancelButton:!0,confirmButtonColor:"#d51b23",confirmButtonText:"Si!",cancelButtonText:"No",closeOnConfirm:!0},function(a){a&&c(f,function(a){j.rol=a.rol;var b=a.rol;switch(b){case"monitor_ps":l(j,!0);break;case"profesional_ps":o(j);break;default:p(j)}})})})}),a("body").on("click",".eliminar_add_fields",function(b){var c=a("#contenedor_add_fields div").length+1,d=a(this).parent("div").children("input").val(),e=a(this).parent("div");d&&swal({title:"Estas seguro/a?",text:"Se desvinculará el prensente monitor del estudiante con codigo "+d,type:"warning",showCancelButton:!0,confirmButtonColor:"#d51b23",confirmButtonText:"Si!",cancelButtonText:"No",closeOnConfirm:!0},function(a){a&&(j(d),e.remove(),c--)})}),a("#agregarCampo").click(function(){a.ajax({type:"POST",data:{"function":"students_consult",instancia:q()},url:"../managers/user_management/usermanagement_report.php",success:function(a){f=a,g(f)},dataType:"json",cache:"false",error:function(a){alert("error al consultar estudiantes")}})})}}});