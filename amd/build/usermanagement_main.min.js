'use strict';define(['jquery','block_ases/bootstrap','block_ases/datatables.net','block_ases/sweetalert','block_ases/select2'],function(a){var g;return{init:function init(){function i(){a.ajax({type:'POST',url:'../managers/user_management/load_role.php',async:!1,success:function success(y){for(role in a('#role_select').empty(),y){var z='<option value="'+y[role].nombre_rol+'">'+y[role].nombre_rol+'</option>';a('#role_select').append(z)}roleLoaded=!0},dataType:'json',error:function error(){alert('error al cargar roles')}})}function j(y,z){var A=y;A||(A=a('#users').val()),a.ajax({type:'POST',data:{dat:A,idinstancia:w()},url:'../managers/user_management/search_user.php',success:function success(B){z?z(B):B.error?(swal('Error',B.error,'error'),a('.assignment_li').addClass('hidden'),a('#form_mon_student').css({display:'none'}),a('#users').val('').trigger('change.select2'),a('#users').prop('disabled',!1),a('#name_lastname').val(' '),a('#search_button').prop('disabled',!1)):(a('#contenedor_add_fields').html(''),''==B.firstname?(swal('Error','El usuario no existe en la base de datos','error'),a('#users').prop('disabled',!1)):(a('.assignment_li').removeClass('hidden'),a('#name_lastname').val(B.firstname+' '+B.lastname),a('#user_id').val(B.id),''==B.rol?a('#role_select').val('no_asignado'):('profesional_ps'==B.rol?(a('#select_prof_type').val(B.profesion),a('#form_prof_type').fadeIn(),a('#boss_li').fadeOut(),a('#form_mon_student').fadeOut()):'monitor_ps'==B.rol?(n(),o(4,B.boss),a('#form_mon_student').fadeIn(),a('#form_prof_type').fadeOut()):'practicante_ps'==B.rol?(o(7,B.boss),a('#form_mon_student').fadeOut(),a('#form_prof_type').fadeOut()):(a('#boss_li').fadeOut(),a('#form_mon_student').fadeOut(),a('#form_prof_type').fadeOut()),a('#role_select').val(B.rol))))},dataType:'json',error:function error(){swal('Error','El usuario no existe en la base de datos','error'),a('.assignment_li').addClass('hidden'),a('#form_mon_student').css({display:'none'}),a('#users').val('').trigger('change.select2'),a('#users').prop('disabled',!1),a('#name_lastname').val(' '),a('#search_button').prop('disabled',!1)}})}function k(){var y=a('#role_select').val(),z=a('#users').val(),A=[];if(a('input[name="array_students[]"]').each(function(){A.push(a(this).val().split(' - ')[0])}),a('select[name="array_students[]"]').each(function(){A.push(a(this).val().split(' - ')[0])}),'profesional_ps'==y){var B=a('#select_prof_type').val();if('no_asignado'==B)swal('Error','El usuario no tiene un "tipo de profesional" asignado, debe asignar un "tipo de profesional".','error');else{var C={role:y,username:z,professional:B,idinstancia:w()};a.ajax({type:'POST',data:C,url:'../managers/user_management/update_role_user.php',success:function success(E){swal('Informaci\xF3n!',E,'info'),j(z)},dataType:'text',cache:'false',error:function error(){swal('Error','Ha ocurrido un error asignando profesional','error')}})}}else if('monitor_ps'==y){var D=a('#boss_select').val();a.ajax({type:'POST',data:{role:y,username:z,students:A,boss:D,idinstancia:w()},url:'../managers/user_management/update_role_user.php',success:function success(E){swal({title:'Informaci\xF3n!',text:E,type:'info',html:!0,confirmButtonColor:'#d51b23',confirmButtonText:'Ok!',closeOnConfirm:!0}),j(z)},dataType:'text',cache:'false',error:function error(){swal('Error','Ha ocurrido un error','error')}})}else if('practicante_ps'==y){var D=a('#boss_select').val();a.ajax({type:'POST',data:{role:y,username:z,boss:D,idinstancia:w()},url:'../managers/user_management/update_role_user.php',success:function success(E){swal({title:'Informaci\xF3n!',text:E,type:'info',html:!0,confirmButtonColor:'#d51b23',confirmButtonText:'Ok!',closeOnConfirm:!0}),j(z)},dataType:'text',cache:'false',error:function error(){swal('Error','Ha ocurrido un error','error')}})}else a.ajax({type:'POST',data:{role:y,username:z,idinstancia:w()},url:'../managers/user_management/update_role_user.php',success:function success(E){swal('Informaci\xF3n!',E,'info')},dataType:'text',cache:'false',error:function error(){swal('Error','Ha ocurrido un error','error')}})}function l(y){a('#'+y).select2({language:{noResults:function noResults(){return'No hay resultado'},searching:function searching(){return'Buscando..'}},dropdownAutoWidth:!0})}function m(y){var A=a('#contenedor_add_fields'),B=a('.inputs_students').length+1,C=B;if(B<=10){C++;var D='<option value="-1">-----------------------</option>';for(var E in y)D+='<option value="'+y[E].username+'">'+y[E].username+' - '+y[E].firstname+' '+y[E].lastname+'</option>';a('#contenedor_add_fields').append('<div class="select-pilos"><select class="inputs_students" name="array_students[]" id="campo_'+C+'"">'+D+'</select></div>'),l('campo_'+C),B++}}function n(){var y=[],z=a('#user_id').val();y.push({name:'function',value:'load_grupal'}),y.push({name:'user_management',value:z}),y.push({name:'idinstancia',value:w()}),a.ajax({type:'POST',data:y,url:'../managers/user_management/seguimiento.php',success:function success(A){if(a('#contenedor_add_fields').html(''),0!=A.rows){for(var C in g)'<option value="'+g[C].username+'">'+g[C].username+' - '+g[C].firstname+' '+g[C].lastname+'</option>';var D=A.content;for(x in D)a('#contenedor_add_fields').append('<div id="contenedor_add_fields"> <div class="added_add_fields"> <input type="text"  class="inputs_students" name="array_students[]" id="campo_1" value="'+D[x].username+' - '+D[x].firstname+' '+D[x].lastname+'" readonly/> <a href="#" class="eliminar_add_fields"><img src="../icon/ico_wrong.png"></a> </div> </div>')}else;},dataType:'json',cache:'false',error:function error(){alert('error al cargar estudiantes')}})}function o(y,z){var A=[],B=0;A.push({name:'function',value:'cargar'}),A.push({name:'role',value:y}),A.push({name:'idinstancia',value:w()}),a.ajax({type:'POST',data:A,url:'../managers/user_management/search_user.php',success:function success(C){for(x in a('#boss_select').html(''),a('#boss_select').append('<option value="ninguno">Ninguno</option>'),C){var D=C[x].firstname.split(' '),E=C[x].lastname.split(' '),F=!1;z==C[x].id?(a('#boss_select').append('<option value="'+C[x].id+'" selected>'+C[x].username+'-'+D[0]+' '+E[0]+'</option>'),F=!0,B=C[x].id):a('#boss_select').append('<option value="'+C[x].id+'" >'+C[x].username+'-'+D[0]+' '+E[0]+'</option>')}a('#boss_li').removeClass('hide')},dataType:'json',cache:'false',error:function error(){alert('error al cargar profesionales')}})}function p(y){var z=[],A=a('#user_id').val(),B=a('#users').val();z.push({name:'deleteStudent',value:'delete'}),z.push({name:'student',value:y.split(' - ')[0]}),z.push({name:'username',value:B}),z.push({name:'idinstancia',value:w()}),a.ajax({type:'POST',data:z,url:'../managers/user_management/update_role_user.php',success:function success(){},dataType:'json',cache:'false',error:function error(){alert('Error al eliminar estudiante')}})}function q(){a.ajax({type:'POST',data:{idinstancia:w()},url:'../managers/user_management/load_role_users.php',success:function success(y){a('#div_users').empty(),a('#div_users').append('<table id="tableUsers" class="display" cellspacing="0" width="100%"><thead><thead></table>');a('#tableUsers').DataTable(y);a('#div_users #delete_user').css('cursor','pointer')},dataType:'json',cache:'false',error:function error(){alert('Error al cargar usuarios')}})}function r(y,z){var A=[];A.push({name:'function',value:'load_grupal'}),A.push({name:'user_management',value:y.id}),A.push({name:'idinstancia',value:w()}),a.ajax({type:'POST',data:A,url:'../managers/user_management/seguimiento.php',success:function success(B){if(0!=B.rows){var C=B.content,D='<p align=justify">Se ha encontrado que el usuario tiene asignado el rol MONITOR y tiene a cargo los siguientes estudiantes:</p><br><br> ';for(x in D+='<div class="pre-scrollable" style="max-height:200px"><table id="tableStudent" class="table table-striped"> <thead> <tr> <th>C\xF3digo</th> <th>Nombre</th> <th>Apellido</th></tr> </thead><tbody>',C)D+='<tr> <td>'+C[x].username+'</td> <td>'+C[x].firstname+'</td> <td>'+C[x].lastname+'</td> </tr>';D+='</tbody></table></div><br><br><p align=justify">Para continuar se crear\xE1 un nuevo usuario con rol monitor quien se har\xE1 a cargo de los anteriores estudiante(s).<br> Por favor escribe el c\xF3digo del nuevo usuario:</p>';var E='';E=z?'Antes de eliminar!':'Antes de Actualizar!',swal({title:E,html:!0,text:D,type:'input',showCancelButton:!0,closeOnConfirm:!1,confirmButtonColor:'#d51b23',confirmButtonText:'Continuar',cancelButtonText:'Cancelar!',animation:'slide-from-top',inputPlaceholder:'C\xF3digo'},function(F){return!1!==F&&(''===F?(swal.showInputError('Escibe el c\xF3digo del nuevo monitor!'),!1):void j(F,function(G){return G.error?swal.showInputError(G.error):s(G,y,z),!1}))})}else k(),q()},dataType:'json',cache:'false',error:function error(){alert('error al validar monitor')}})}function s(y,z,A){var B='';B='ninguno'==y.rol?'El usuario <strong>'+y.firstname+' '+y.lastname+'</strong> con c\xF3digo <strong>'+y.username+'</strong> se le asiganara el rol monitor y tendr\xE1 a cargo los estudiantes del anterior monitor<br>\xBFEst\xE1 de acuerdo con los cambios que se efectuar\xE1n?':'El usuario <strong>'+y.firstname+' '+y.lastname+'</strong> con c\xF3digo <strong>'+y.username+'</strong> ya tiene el rol <strong>'+y.rol+'</strong>  en el sistema.<br>Perder\xE1 el presente rol y se le asiganar\xE1 el rol monitor.<br> Tendr\xE1 a cargo los estudiantes del anterior monitor.<br><br><strong>\xBFEst\xE1s de acuerdo con los cambios que se efectuar\xE1n?</strong>',swal({title:'Est\xE1s seguro/a?',text:B,type:'warning',html:!0,showCancelButton:!0,confirmButtonColor:'#d51b23',confirmButtonText:'Si!',cancelButtonText:'Atras!',closeOnConfirm:!1,closeOnCancel:!1,animation:'slide-from-top'},function(C){C?t(y,z,A):r(z,A)})}function t(y,z,A){var B=[];B.push({name:'changeMonitor',value:'changeMonitor'}),B.push({name:'oldUser',value:JSON.stringify([z.id,z.username])}),B.push({name:'newUser',value:JSON.stringify([y.id,y.username])}),B.push({name:'isdelete',value:A}),B.push({name:'idinstancia',value:w()}),a.ajax({type:'POST',data:B,url:'../managers/user_management/update_role_user.php',success:function success(C){1==C?(A?swal('Eliminado!','El proceso se eliminaci\xF3n de complet\xF3 satisfactoriamente.','success'):(swal('Hecho!','El proceso de reasignaci\xF3n de estudiantes se complet\xF3 satisfactoriamente. Por favor actualiza y guarda el nuevo rol','success'),k(),q()),q()):swal('Error!',C,'error')},dataType:'text',cache:'false',error:function error(){alert('Error al cambiar monitor')}})}function u(y){var z=[];z.push({name:'deleteProfesional',value:'deleteProfesional'}),z.push({name:'user',value:JSON.stringify([y.id,y.username])}),z.push({name:'idinstancia',value:w()}),a.ajax({type:'POST',data:z,url:'../managers/user_management/update_role_user.php',success:function success(A){1==A?(swal('Eliminado!','El proceso se eliminaci\xF3n de complet\xF3 satisfactoriamente.','success'),q()):swal('Error!',A,'error')},dataType:'json',cache:'false',error:function error(){alert('Error al eliminar profesional')}})}function v(y){var z=[];z.push({name:'deleteOtheruser',value:'deleteOtheruser'}),z.push({name:'user',value:JSON.stringify([y.id,y.username,y.rol])}),z.push({name:'idinstancia',value:w()}),a.ajax({type:'POST',data:z,url:'../managers/user_management/update_role_user.php',success:function success(A){1==A?(swal('Eliminado!','El proceso se eliminaci\xF3n de complet\xF3 satisfactoriamente.','success'),q()):swal('Error!',A,'error')},dataType:'json',cache:'false',error:function error(){alert('Error al eliminar otros usuarios')}})}function w(){var y=location.search.split('&');for(x in y)if(0<=y[x].indexOf('instanceid')){var z=y[x].split('=');return z[1]}return 0}a('#collapse_div').removeClass('hidden'),a('#users').select2({language:{noResults:function noResults(){return'No hay resultado'},searching:function searching(){return'Buscando..'}},dropdownAutoWidth:!0}),a(document).ready(function(){a('.assignment_li').css({display:'none'}),a('#form_mon_student').css({display:'none'}),a('#search_button').on('click',function(){a('#search_button').prop('disabled',!0),i(),j(),a('#users').prop('disabled',!0),a('.assignment_li').show()}),a('#ok-button').on('click',function(){var z=a('#role_select').val();j(null,function(A){if('monitor_ps'==A.rol&&A.rol!=z){var B=[];B.id=a('#user_id').val(),B.username=a('#users').val(),r(B,!1)}else k(),q()})}),a('#cancel-button').on('click',function(){a('.assignment_li').addClass('hidden'),a('#boss_li').fadeOut(),a('#form_mon_student').fadeOut(),a('#users').val('').trigger('change.select2'),a('#users').prop('disabled',!1),a('#search_button').prop('disabled',!1),a('#name_lastname').val(' '),a('#form_prof_type').fadeOut()}),a('#form_mon_estudiante').css({display:'none'}),a('#form_prof_type').css({display:'none'}),a('#role_select').on('change',function(){'monitor_ps'==a('#role_select').val()?(a('#form_prof_type').fadeOut(),a('#form_mon_student').fadeIn(),o(4),a('#boss_li').fadeIn()):'profesional_ps'==a('#role_select').val()?(a('#form_prof_type').fadeIn(),a('#boss_li').fadeOut(),a('#form_mon_student').fadeOut()):'practicante_ps'==a('#role_select').val()?(a('#form_prof_type').fadeOut(),a('#form_mon_student').fadeOut(),o(7),a('#boss_li').fadeIn()):(a('#boss_li').fadeOut(),a('#form_mon_student').fadeOut(),a('#form_prof_type').fadeOut())}),a('#list-users-panel').on('click',function(){q()}),a('#div_users').on('click','#delete_user',function(){var z=a('#div_users #tableUsers').DataTable(),A=a(this).parent(),B=a(this).children('span').attr('id'),C=z.cell(A).index().column,D=z.cell(z.row(A).index(),0).data(),E=z.cell(z.row(A).index(),1).data(),F=z.cell(z.row(A).index(),2).data(),G=z.cell(z.row(A).index(),3).data(),H=[];H.id=B,H.username=D,swal({title:'Estas seguro/a?',text:'Al usuario <strong>'+E+' '+F+'</strong> con c\xF3digo <strong>'+D+'</strong> se le inhabilitar\xE1 los permisos del rol <strong>'+G+'</strong>.<br><strong>\xBFEst\xE1s de acuerdo con los cambios que se efectuar\xE1n?</strong>',type:'warning',html:!0,showCancelButton:!0,confirmButtonColor:'#d51b23',confirmButtonText:'Si!',cancelButtonText:'No',closeOnConfirm:!0},function(I){I&&j(D,function(J){H.rol=J.rol;var K=J.rol;'monitor_ps'===K?r(H,!0):'profesional_ps'===K?u(H):v(H)})})})}),a('body').on('click','.eliminar_add_fields',function(){var z=a('#contenedor_add_fields div').length+1,A=a(this).parent('div').children('input').val(),B=a(this).parent('div');A&&swal({title:'Estas seguro/a?',text:'Se desvincular\xE1 el prensente monitor del estudiante con codigo '+A,type:'warning',showCancelButton:!0,confirmButtonColor:'#d51b23',confirmButtonText:'Si!',cancelButtonText:'No',closeOnConfirm:!0},function(C){C&&(p(A),B.remove(),z--)})}),a('#agregarCampo').click(function(){a.ajax({type:'POST',data:{function:'students_consult',instancia:w()},url:'../managers/user_management/seguimiento.php',success:function success(y){g=y,m(g)},dataType:'json',cache:'false',error:function error(){alert('error al consultar estudiantes')}})})}}});