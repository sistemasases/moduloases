'use strict';var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a};define(['jquery','core/notification','core/templates','block_ases/ases_jquery_datatable','core/config','block_ases/sweetalert','block_ases/loading_indicator','block_ases/jquery.dataTables','block_ases/dataTables.buttons','block_ases/buttons.html5','block_ases/buttons.flash','block_ases/buttons.print'],function(a,b,c,d,e,f,g){var q=0,r='continue-button',t=function(){return a('#cohorts').val()},u=function(){return a('#endpoints').val()},v=function(){a('#user-notifications .alert-error').remove()},w=function(V,W,X){return V.replace(new RegExp(W,'g'),X)},x=/[ -() \[\].]/,z=function(){a('body,html').animate({scrollTop:0},500)},A=function(V,W){'SI'===W.error&&(a(V).addClass('error'),W.errors&&Object.keys(W.errors).forEach(function(X){a('td.'+X,V).addClass('error'),console.log(W.errors);var Y=W.errors[X].map(function(_){return _.error_message}),Z=Y.join('; ');a('td.'+X,V).prop('title',Z)}))},B=function(V){V.destroy=!0,V.autoWidth=!1;var W=a('#example');a.fn.dataTable.isDataTable('#example')&&W.DataTable().destroy(),W.DataTable(V)},C=function(V){return e.wwwroot+'/blocks/ases/managers/mass_management/mass_upload_api.php/'+u()+'/'+t()+'/'+q+'/'+V},D=function(){a.fn.DataTable.isDataTable('#example')&&a('#example').DataTable().destroy()},E=function(){a('#messages_area').html('')},F=function(V){var W=[];return Object.keys(V).forEach(function(X){W=W.concat(V[X])}),W},G=function(){a('select').prop('disabled',!1)},H=function(){function V(W,X,Y,Z,_,aa,ba){this.data=W,this.object_errors=X?X:[],this.object_warnings=Y?Y:[],this.jquery_datatable=_?_:{},this.success_logs_events=Z?Z:[],this.error=aa,this.initial_object_properties=ba?ba:[]}return V.prototype.get_messages=function(){console.log(this);for(var W=[],X=0;X<this.data.length;X++)(this.object_errors[X]&&'object'===_typeof(this.object_errors[X])&&this.object_errors[X].constructor!==Array||this.object_warnings[X]&&0<this.object_warnings[X].length||this.success_logs_events[X]&&0<this.success_logs_events[X].length)&&W.push(new T(X+1,this.object_errors[X],this.object_warnings[X],this.success_logs_events[X]));return W},V.get_from_response=function(W){var X=JSON.parse(W);return new V(X.data,X.object_errors,X.object_warnings,X.success_log_events,X.jquery_datatable,X.error,X.initial_object_properties)},V}(),I=function(V,W){if(V.dom='Bfrtip',B(V),W.data_response&&W.data_response.object_properties&&W.data_response.file_headers){var X=W.data_response.object_properties,Y=W.data_response.file_headers,Z=[];Z=Z.concat(X.filter(function(aa){return 0>Y.indexOf(aa)}));var _=[];_=_.concat(Y.filter(function(aa){return-1>=X.indexOf(aa)})),0<Z.length&&Z.forEach(function(aa){a('.'+aa).css('background-color','#cccccc').attr('title','Columna faltante'),console.log(aa)}),0<_.length&&_.forEach(function(aa){console.log(aa),a('.'+aa).css('background-color','red').attr('title','Columna sobrante')})}},J=function(){return a('#send-file')},K=function(){return new FormData(a('#form-send-file').get(0))},L=function(V){var W=C(V),X=K();return g.show(),a.ajax({url:W,data:X,cache:!1,contentType:!1,dataType:'html',processData:!1,type:'POST'}).then(function(Y){return g.hide(),Y}).catch(function(Y){return g.hide(),z(),f({title:'Ocurrio un error',text:'En la secci\xF3n de notificaciones se muestra la lista de errores, adicionalmente en la consolase muestra informaci\xF3n detallada de los errores y su contexto',type:'error',closeOnConfirm:!0,confirmButtonText:'Aceptar'}),Y})},M=function(){a('#'+r).remove()},N=function(){var V=J();return V.clone(!0).off().attr('id',r).html('Almacenar informaci\xF3n').attr('title','Guardar informaci\xF3n de forma persistente en la base de datos').appendTo('#buttons-section')},O=function(){f({title:'Confirmaci\xF3n de guardado',text:'Una vez acepte almacenar la informaci\xF3n, todo lo que se ha mostrado que se guardarava a ser almacenado en la base de datos y no habr\xE1 forma de volver a un estado anterior.Si da click en cancelar la base de datos no sufrira ningun cambio.',type:'warning',closeOnConfirm:!0,closeOnCancel:!0,showCancelButton:!0,confirmButtonText:'Almacenar informaci\xF3n?'},function(V){V&&(M(),Q(!0).then(function(){f({title:'La informaci\xF3n se ha guardado correctamente',text:'',type:'success',closeOnConfirm:!0,closeOnCancel:!0,showCancelButton:!1,confirmButtonText:'Vale'}),G()}))})},P=function(){N().html('Nada para guardar').attr('disabled',!0)},Q=function(V){return D(),L(V).then(function(W){console.log(W,'response'),v(),D(),E();var X=H.get_from_response(W),Y=X.object_errors,Z=X.jquery_datatable,_=X.get_messages();c.render('block_ases/massive_upload_messages',{data:_}).then(function(aa,ba){c.appendNodeContents('#messages_area',aa,ba)}),Object.keys(Y).forEach(function(aa){Z.data[aa].errors=Y[aa]}),Z.data.forEach(function(aa,ba){aa.index=ba+1}),Z.data.forEach(function(aa,ba){aa.error=Y[ba]&&(0<Y[ba].length||Y[ba].constructor===Object)?'SI':'NO'}),Z.columns.unshift({name:'index',data:'index',title:'Linea'}),Z.columns.push({name:'error',title:'Error',data:'error'}),Z.rowCallback=A,Z.initComplete=d.add_column_filters(['error:name']),B(Z),console.log(V,'continue antes de a\xF1adir el boton continue'),X.error||V||(0===X.success_logs_events.length?P():N().click(O))}).catch(function(W){v(),D(),E();var X=JSON.parse(W.responseText);console.log(X,'error object at catch send file');var Y=X.datatable_preview;if(X.object_errors&&X.object_errors.generic_errors){var Z=X.object_errors.generic_errors.map(function(_){return _.error_message});I(Y,X.object_errors.generic_errors[0]),Z.forEach(function(_){console.log(_),b.addNotification({message:_,type:'error'})})}})},S=function(){return Q(!1)},T=function(){return function(W,X,Y,Z){this.index=W,this.errors=X?F(X):[],this.warnings=Y?Y:[],this.success_logs=Z?Z:[]}}(),U=function(){a('#user-notifications').prependTo(a('.massive_upload'))};return{init:function init(V){a('select').change(function(){M()}),q=V.instance_id,a('#send-file').click(function(){M(),S().catch(function(){G()})}),U()}}});