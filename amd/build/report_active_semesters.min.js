'use strict';define(['jquery','block_ases/Chart','block_ases/loading_indicator','block_ases/jquery.dataTables','block_ases/dataTables.autoFill','block_ases/dataTables.buttons','block_ases/buttons.html5','block_ases/buttons.flash','block_ases/buttons.print'],function(a,b,c){return{init:function init(e){function f(J,K){var L=[],M;for(M=0;M<K.length;M++)J.includes(K[M])&&L.push(M);return L}function g(J,K,L){a('#tableActiveSemesters tfoot th').html(''),a('#tableActiveSemesters tfoot tr.total_students th')[1].textContent='Total Estudiantes'+' '+L,a('#tableActiveSemesters tfoot tr.total_nochange th')[1].textContent='Activos sin cambio de carrera'+' '+L,a('#tableActiveSemesters tfoot tr.total_change th')[1].textContent='Activos con cambio de carrera'+' '+L,a('#tableActiveSemesters tfoot tr.total_active th')[1].textContent=u+' '+L,a('#tableActiveSemesters tfoot tr.total_inactive th')[1].textContent='inactivos'+' '+L,a('#tableActiveSemesters tfoot tr.total_grads th')[1].textContent='Egresados'+' '+L,K.forEach(function(M){a('#tableActiveSemesters tfoot tr.total_students th.'+M).html(J.total_students),a('#tableActiveSemesters tfoot tr.total_nochange th.'+M).html(J.semesters[M][0]-J.semesters[M][2]),a('#tableActiveSemesters tfoot tr.total_change th.'+M).html(J.semesters[M][2]),a('#tableActiveSemesters tfoot tr.total_active th.'+M).html(J.semesters[M][0]),a('#tableActiveSemesters tfoot tr.total_inactive th.'+M).html(J.total_students-(J.semesters[M][0]+J.semesters[M][1])),a('#tableActiveSemesters tfoot tr.total_grads th.'+M).html(J.semesters[M][1])})}function h(J,K){return J.filter(function(L){return-1!==K.indexOf(L)}).length===K.length}function k(){var J=document.getElementById('active_semesters_chart').toDataURL();a('#download_percentage_desertion').click(function(){a(this).attr('href',J)})}function l(J,K,L,M,N){var O=[],P=[],Q=[];J.forEach(function(U){O.push(K[U]),P.push(L[U]),Q.push(M[U])});var S=document.getElementById('active_semesters_chart'),T=S.getContext('2d');window.myLine=new b(T,{type:'line',data:{labels:J,datasets:[{label:'Porcentaje de estudiantes activos durante el periodo',backgroundColor:'green',borderColor:'green',data:Q,fill:!1},{label:'Porcentaje de estudiantes inactivos durante el periodo',backgroundColor:'red',borderColor:'red',data:O,fill:!1},{label:'Porcentaje de estudiantes graduados durante el periodo',backgroundColor:'blue',borderColor:'blue',data:P,fill:!1}]},options:{animation:{onComplete:function onComplete(){N()}},responsive:!0,title:{display:!0,text:'Reporte deserci\xF3n'},tooltips:{mode:'index',intersect:!1},hover:{mode:'nearest',intersect:!0},scales:{xAxes:[{display:!0,scaleLabel:{display:!0,labelString:'Periodo'}}],yAxes:[{display:!0,scaleLabel:{display:!0,labelString:'Porcentaje'}}]}}})}function m(J){c.show();a.ajax({method:'POST',url:'../managers/report_active_semesters/report_active_semesters_api.php/'+n,data:{function:'data_table',params:{instance_id:n,cohort_id:J}},dataType:'json'}).done(function(M){c.hide();var N=M.dataTable;a('#download_percentage_desertion').css('display','inline'),z=M.semesters;var O=N.columns,P=O.map(function(R){return R.name}),Q=N.data.length;console.log(z),E=new D(z,Q),E.init_from_data(N.data,z),F=new A(E,z),G=new B(E,z),H=new C(E,z),l(z,F,G,H,k),N.rowCallback=function(R,S){a(z).each(function(U,V){S[V].includes('SI')?a('td.'+V,R).addClass('active_semester'):S[V].includes('EGRESADO')&&a('td.'+V,R).addClass('graduated_student')})},N.initComplete=function(){a('th:contains(\'20\')').each(function(){a(this).addClass('Semestre')});var R=N.columns.map(function(U){return U.name?U.name:null}),S=z;S.push('num_carreras'),console.log(z);var T=f(S,R);this.api().columns(T).every(function(){var U=this,V=a('<select><option value=""></option></select>').on('change',function(){var W=a.fn.dataTable.util.escapeRegex(a(this).val());U.search(W?'^'+W+'$':'',!0,!1).draw()});U.data().unique().sort().each(function(W){V.append('<option value="'+W+'">'+W+'</option>')})})},a.fn.dataTable.isDataTable('#tableActiveSemesters')&&(a('#div_table_report').html(''),a('#div_table_report').fadeIn(1e3).append('<table id="tableActiveSemesters" class="table" cellspacing="0" width="100%"></table>')),o=a('#tableActiveSemesters').DataTable(N),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_students'))),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_nochange'))),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_change'))),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_active'))),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_inactive'))),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_grads'))),g(E,z,J),h(P,y)||console.error(' Las columnas dadas no coinciden con las columnas conocidas.','columnas daads:',P,'columnas conocidas: ',y)}).fail(function(){c.hide()})}var n=e.instance_id,o=null,u='Total activos',y=['codigo','nombre','num_doc'];a(document).on('click','#tableActiveSemesters tbody tr td',function(){var K=a('#tableActiveSemesters').DataTable(),L=K.cell(this).index().column;if(0<=L&&2>=L){var M='student_profile.php'+location.search+'&student_code='+K.cell(K.row(this).index(),0).data(),N=window.open(M,'_blank');N.focus()}});var z=[],A=function(){return function(K,L){var N=this,M=K.total_students;L.forEach(function(O){var P=M-(K.semesters[O][0]+K.semesters[O][1]);N[O]=100*P/M})}}(),B=function(){return function(K,L){var N=this,M=K.total_students;L.forEach(function(O){var P=K.semesters[O][1];N[O]=100*P/M})}}(),C=function(){return function(K,L){var N=this,M=K.total_students;L.forEach(function(O){var P=K.semesters[O][0];N[O]=100*P/M})}}(),D=function(){function J(K,L){this.total_students=L?L:0,this.semesters=[];for(var M=K.length,N=0;N<M;N++)this.semesters[K[N]]=[0,0,0,0]}return J.prototype.init_from_data=function(L,M){var O=this;L.forEach(function(P){var Q='';M.forEach(function(R){P[R].includes('NO')||P[R].includes('EGRESADO')||(!P[R].includes(Q)&&''!=Q&&O.semesters[R][2]++,Q=P[R]),P[R].includes('SI')?O.semesters[R][0]++:P[R].includes('EGRESADO')&&O.semesters[R][1]++})});var N=0;M.forEach(function(P){N+=O.semesters[P][2],O.semesters[P][2]=N})},J}(),E=null,F=null,G=null,H=null;a('#cohorts').change(function(){var J=a('#cohorts option:selected').val();a('#tableActiveSemesters tfoot th')[0].textContent=u+' '+J,m(J)});var I=a('#cohorts option:selected').val();m(I)}}});